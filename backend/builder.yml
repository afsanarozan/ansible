---
  - name: Build Docker
    hosts: db-center
    vars_files:
      - vars.yml

    tasks:
      - name: Check connection node
        become: true
        ping:
      
      - name: Install Docker
        become: true
        yum:
          name: docker
          state: present
      
      - name: Ensure docker is running
        become: true
        service:
          name: docker
          state: started
          enabled: yes
      
      - name: Add user to group Docker
        become: true
        user:
          name: ansman
          shell: /bin/bash
          groups: docker
          append: yes
          
      - name: "Ensure git installed"
        become: true
        yum:
          name: git
          state: present
      
      - name: "Installing Python Docker"
        become: true
        pip:
          name: docker
      
      - name: "Clone Git Repository"
        git:
          repo: "{{repo}}"
          dest: "{{dests}}/{{proj}}"
          update: yes

      - name: Pull latest changes
        command: git pull 
        args:
          chdir: "{{dests}}/{{proj}}"

      # - name: Stop Docker container
      #   command: docker stop {{hub}}/{{proj}
      #   register: rm 
      #   failed_when: rm.rc != 1 and rm.rc != 0

      - name: Remove backend Container
        command: docker rm {{hub}}/{{proj}
        register: rm
        failed_when: rm.rc != 1 and rm.rc != 0

      - name: Remove image
        community.general.docker_image:
          state: absent
          name: "{{hub}}/{{proj}}"

      - name: "Build image"
        community.general.docker_image:
          name: "{{hub}}/{{proj}}"
          build:
            path: "{{dests}}/{{proj}}"
            dockerfile: Dockerfile
          source: build
          state: present
  
        
